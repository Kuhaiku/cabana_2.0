<!doctype html>
<html lang="pt-br" class="scroll-smooth">
  <head>
    <meta charset="UTF-8" />
    <title>Cabana | Orçamento</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600;700&family=Nunito:wght@400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: {
              sans: ["Nunito", "sans-serif"],
              display: ["Fredoka", "sans-serif"],
            },
            colors: {
              brand: { pink: "#FF6B95", dark: "#2D2A4A", soft: "#FFF5F8" },
            },
          },
        },
      };
    </script>
    <style>
      .clean-input {
        width: 100%;
        background: #f8fafc;
        border: 2px solid #f1f5f9;
        border-radius: 1rem;
        padding: 0.8rem;
        outline: none;
      }
      .clean-input:focus {
        border-color: #ff6b95;
      }
    </style>
  </head>
  <body class="font-sans text-slate-600 bg-white antialiased pb-20">
    <header
      class="py-4 border-b border-slate-50 sticky top-0 z-[60] bg-white/90 backdrop-blur-md"
    >
      <div class="container mx-auto px-6 flex justify-between items-center">
        <div class="text-xl font-display font-bold text-brand-pink">
          Cabana<span class="text-brand-dark">.Brincar</span>
        </div>
        <a
          href="index.html"
          class="bg-slate-100 px-4 py-2 rounded-full text-xs font-bold"
          >Voltar</a
        >
      </div>
    </header>
    <main
      class="container mx-auto lg:px-4 lg:py-8 grid grid-cols-1 lg:grid-cols-12 gap-8"
    >
      <div class="lg:col-span-5 sticky top-24 z-50">
        <div
          class="p-4 lg:bg-brand-soft lg:rounded-[2.5rem] flex justify-center"
        >
          <canvas
            id="simuladorCanvas"
            width="1080"
            height="1080"
            class="h-64 lg:h-[500px] w-auto object-contain drop-shadow-xl rounded-xl bg-white"
          ></canvas>
        </div>
      </div>
      <form id="orcamentoForm" class="lg:col-span-7 space-y-8 px-4 lg:px-0">
        <section
          class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm"
        >
          <h2 class="font-display font-bold text-brand-dark mb-4">1. Estilo</h2>
          <div class="grid md:grid-cols-2 gap-4">
            <select
              id="modelo_barraca"
              onchange="atualizarSimulador()"
              class="clean-input"
            >
              <option value="">Carregando...</option>
            </select>
            <input
              type="text"
              id="tema"
              placeholder="Tema"
              class="clean-input"
            />
            <input
              type="text"
              id="cores"
              placeholder="Cores"
              class="clean-input"
            />
          </div>
        </section>
        <section
          class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm"
        >
          <h2 class="font-display font-bold text-brand-dark mb-4">2. Itens</h2>
          <div
            class="grid grid-cols-2 gap-3"
            id="container-personalizacao"
          ></div>
        </section>
        <section
          class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm"
        >
          <h2 class="font-display font-bold text-brand-dark mb-4">3. Menu</h2>
          <div class="grid grid-cols-2 gap-3" id="container-alimentacao"></div>
        </section>
        <section
          class="bg-white p-6 rounded-[2rem] border border-slate-100 shadow-sm"
        >
          <h2 class="font-display font-bold text-brand-dark mb-4">
            4. Finalizar
          </h2>
          <div class="grid md:grid-cols-2 gap-4">
            <input
              type="text"
              id="nome"
              placeholder="Nome"
              required
              class="clean-input col-span-2"
            />
            <input
              type="tel"
              id="whatsapp"
              placeholder="WhatsApp"
              required
              class="clean-input"
            />
            <input
              type="text"
              id="endereco"
              placeholder="Endereço"
              required
              class="clean-input"
            />
            <input type="date" id="data_festa" class="clean-input" />
            <input type="time" id="horario" class="clean-input" />
            <input
              type="number"
              id="qtd_criancas"
              placeholder="Crianças"
              class="clean-input"
            />
            <input
              type="number"
              id="qtd_barracas"
              placeholder="Barracas"
              class="clean-input"
            />
            <textarea
              id="itens_adicionais"
              placeholder="Obs..."
              class="clean-input col-span-2"
            ></textarea>
            <textarea
              id="alergias"
              placeholder="Alergias"
              class="clean-input col-span-2"
            ></textarea>
          </div>
        </section>
        <button
          type="submit"
          class="w-full bg-brand-dark text-white font-display font-bold text-xl py-5 rounded-2xl shadow-xl"
        >
          Solicitar Orçamento
        </button>
      </form>
    </main>
    <script>
      const CLOUD_NAME = "SEU_CLOUD_NAME_AQUI"; // <--- COLOQUE SEU CLOUD NAME
      const BASE_ASSETS_URL = `https://res.cloudinary.com/${CLOUD_NAME}/image/upload/v1/cabana/assets/`;

      lucide.createIcons();
      const canvas = document.getElementById("simuladorCanvas");
      const ctx = canvas.getContext("2d");

      function verificarItem(selecionados, palavra) {
        return selecionados.some((n) => n.toLowerCase().includes(palavra));
      }
      function obterSufixo(nome) {
        return nome &&
          (nome.toLowerCase().includes("pijama") ||
            nome.toLowerCase().includes("tenda"))
          ? "pijama"
          : "indio";
      }
      function getAssetPath(mod, item, st) {
        const tipo = obterSufixo(mod);
        let fn =
          item === "base"
            ? st === "com_luz"
              ? `base_${tipo}_luz.png`
              : `base_${tipo}.png`
            : `item_${item}_${tipo}.png`;
        return BASE_ASSETS_URL + fn;
      }
      function carregarImagem(src) {
        return new Promise((r) => {
          const i = new Image();
          i.crossOrigin = "Anonymous";
          i.src = src;
          i.onload = () => r(i);
          i.onerror = () => r(null);
        });
      }
      async function atualizarSimulador() {
        ctx.clearRect(0, 0, 1080, 1080);
        const checked = Array.from(
          document.querySelectorAll("input:checked"),
        ).map((i) => i.value);
        const modelo =
          document.getElementById("modelo_barraca").options[
            document.getElementById("modelo_barraca").selectedIndex
          ]?.text || "";
        if (modelo) {
          const cam = [
            getAssetPath(
              modelo,
              "base",
              verificarItem(checked, "luz") ? "com_luz" : "sem_luz",
            ),
          ];
          if (
            verificarItem(checked, "colchonete") ||
            verificarItem(checked, "colchao")
          )
            cam.push(getAssetPath(modelo, "colchonete"));
          if (verificarItem(checked, "almofada"))
            cam.push(getAssetPath(modelo, "almofadas"));
          if (verificarItem(checked, "mesa"))
            cam.push(getAssetPath(modelo, "mesa"));
          const imgs = await Promise.all(cam.map((src) => carregarImagem(src)));
          imgs.forEach((i) => {
            if (i) ctx.drawImage(i, 0, 0, 1080, 1080);
          });
        }
      }
      async function iniciar() {
        const res = await fetch("/api/itens-disponiveis");
        const itens = await res.json();
        const sel = document.getElementById("modelo_barraca");
        sel.innerHTML = "";
        itens
          .filter((i) => i.categoria === "tendas")
          .forEach((t) => {
            const o = document.createElement("option");
            o.value = t.descricao;
            o.text = t.descricao;
            sel.appendChild(o);
          });
        const render = (cat, id) => {
          document.getElementById(id).innerHTML = itens
            .filter((i) => i.categoria === cat)
            .map(
              (i) =>
                `<label class="flex gap-2 p-2 border rounded cursor-pointer"><input type="checkbox" value="${i.descricao}" ${cat === "padrao" ? "checked" : ""} onchange="atualizarSimulador()"><span>${i.descricao}</span></label>`,
            )
            .join("");
        };
        render("padrao", "container-personalizacao");
        render("alimentacao", "container-alimentacao");
        atualizarSimulador();
      }
      document
        .getElementById("orcamentoForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector("button");
          btn.innerText = "Enviando...";
          btn.disabled = true;
          const itens_p = Array.from(
            document.querySelectorAll(
              "#container-personalizacao input:checked",
            ),
          ).map((i) => i.value);
          const alim = Array.from(
            document.querySelectorAll("#container-alimentacao input:checked"),
          ).map((i) => i.value);
          const data = {
            nome: document.getElementById("nome").value,
            whatsapp: document.getElementById("whatsapp").value,
            endereco: document.getElementById("endereco").value,
            qtd_criancas: document.getElementById("qtd_criancas").value,
            modelo_barraca: document.getElementById("modelo_barraca").value,
            qtd_barracas: document.getElementById("qtd_barracas").value,
            tema: document.getElementById("tema").value,
            cores: document.getElementById("cores").value,
            itens_padrao: itens_p,
            itens_adicionais: document.getElementById("itens_adicionais").value,
            alimentacao: alim,
            data_festa: document.getElementById("data_festa").value,
            horario: document.getElementById("horario").value,
            alergias: document.getElementById("alergias").value,
          };
          try {
            await fetch("/api/orcamento", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify(data),
            });
            alert("Sucesso!");
            window.location.href = "index.html";
          } catch {
            alert("Erro");
            btn.disabled = false;
            btn.innerText = "Solicitar Orçamento";
          }
        });
      window.onload = iniciar;
    </script>
  </body>
</html>
