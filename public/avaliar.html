<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliar Minha Festa | Cabana de Brincar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
</head>
<body class="bg-slate-50 font-sans min-h-screen flex items-center justify-center p-6">

    <div class="max-w-md w-full bg-white rounded-3xl shadow-xl p-8 border border-slate-100">
        <div class="text-center mb-8">
            <h1 class="text-2xl font-bold text-slate-800">Sua opinião é mágica! ✨</h1>
            <p class="text-slate-500 mt-2">Conte-nos como foi a experiência com a Cabana de Brincar.</p>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-bold text-slate-700 mb-2">Sua nota:</label>
            <div id="star-rating" class="flex gap-2 text-4xl text-slate-300">
                <button onclick="setRating(1)" class="star hover:scale-110 transition-transform">★</button>
                <button onclick="setRating(2)" class="star hover:scale-110 transition-transform">★</button>
                <button onclick="setRating(3)" class="star hover:scale-110 transition-transform">★</button>
                <button onclick="setRating(4)" class="star hover:scale-110 transition-transform">★</button>
                <button onclick="setRating(5)" class="star text-yellow-400">★</button>
            </div>
        </div>

        <div class="mb-6">
            <label class="block text-sm font-bold text-slate-700 mb-2">Seu comentário:</label>
            <textarea id="comentario" maxlength="350" rows="4" 
                class="w-full px-4 py-3 rounded-xl border border-slate-200 focus:ring-2 focus:ring-pink-300 focus:border-pink-400 outline-none transition-all resize-none"
                placeholder="O que as crianças mais gostaram?"></textarea>
            <div class="text-right text-xs text-slate-400 mt-1"><span id="char-count">0</span>/350</div>
        </div>

        <div class="mb-8">
            <label class="block text-sm font-bold text-slate-700 mb-2">Fotos da festa (até 5):</label>
            <button id="upload-widget" class="w-full flex items-center justify-center gap-2 border-2 border-dashed border-slate-300 p-4 rounded-xl text-slate-500 hover:border-pink-400 hover:text-pink-500 transition-colors">
                <i data-lucide="camera"></i>
                <span>Adicionar Fotos</span>
            </button>
            <div id="preview-fotos" class="flex gap-2 mt-4 overflow-x-auto pb-2"></div>
        </div>

        <button onclick="enviarAvaliacao()" id="btn-enviar"
            class="w-full bg-pink-500 text-white font-bold py-4 rounded-2xl shadow-lg shadow-pink-200 hover:bg-pink-600 transition-all active:scale-95 flex items-center justify-center gap-2">
            <span>Enviar Avaliação</span>
            <i data-lucide="send" class="w-5 h-5"></i>
        </button>
    </div>

    <script>
        let currentRating = 5;
        let fotosEnviadas = [];
        const urlParams = new URLSearchParams(window.location.search);
        const token = urlParams.get('t'); // Pega o token da URL (?t=abc123)

        // Inicializa Ícones
        lucide.createIcons();

        // Contador de caracteres
        document.getElementById('comentario').addEventListener('input', (e) => {
            document.getElementById('char-count').innerText = e.target.value.length;
        });

        // Lógica de Estrelas
        function setRating(n) {
            currentRating = n;
            const stars = document.querySelectorAll('.star');
            stars.forEach((s, i) => {
                s.classList.toggle('text-yellow-400', i < n);
                s.classList.toggle('text-slate-300', i >= n);
            });
        }

        // Configuração do Widget Cloudinary
        const myWidget = cloudinary.createUploadWidget({
            cloudName: 'SEU_CLOUD_NAME', // Substitua
            uploadPreset: 'SEU_PRESET',   // Substitua
            folder: 'cabana de brincar/fotos_depoimento',
            maxFiles: 5,
            clientAllowedFormats: ["png", "jpg", "jpeg", "webp"],
            theme: "minimal"
        }, (error, result) => {
            if (!error && result && result.event === "success") { 
                fotosEnviadas.push(result.info.secure_url);
                renderPreview();
            }
        });

        document.getElementById("upload-widget").addEventListener("click", () => myWidget.open());

        function renderPreview() {
            const container = document.getElementById('preview-fotos');
            container.innerHTML = fotosEnviadas.map(url => `
                <img src="${url}" class="w-16 h-16 object-cover rounded-lg border border-slate-200">
            `).join('');
        }

        // Envio Final
        async function enviarAvaliacao() {
            if (!token) return alert("Link inválido. Solicite um novo link de avaliação.");
            
            const comentario = document.getElementById('comentario').value;
            if (!comentario) return alert("Por favor, escreva um pequeno comentário.");

            const btn = document.getElementById('btn-enviar');
            btn.disabled = true;
            btn.innerText = "Enviando...";

            try {
                const response = await fetch('/api/cliente/avaliar', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        token: token,
                        rating: currentRating,
                        comentario: comentario,
                        fotos: fotosEnviadas
                    })
                });

                if (response.ok) {
                    alert("Obrigado! Sua avaliação foi enviada com sucesso.");
                    window.location.href = "index.html";
                } else {
                    throw new Error();
                }
            } catch (err) {
                alert("Erro ao enviar. Tente novamente.");
                btn.disabled = false;
                btn.innerHTML = '<span>Enviar Avaliação</span> <i data-lucide="send"></i>';
                lucide.createIcons();
            }
        }
    </script>
</body>
</html>